import streamlit as st 
import speech_recognition as sr
import pyttsx3
from llama_cpp import Llama

# ========= LOAD LOCAL MODEL =========
model_path = r"D:\praveen\models\CapybaraHermes-2.5-Mistral-7B\capybarahermes-2.5-mistral-7b.Q4_K_S.gguf"
llm = Llama(model_path=model_path, n_ctx=4096)

# ========= TTS =========
engine = pyttsx3.init()

# ========= ROLES =========
roles = {
    "Engineer": "software development and programming",
    "Sales": "sales and customer persuasion",
    "Retail Associate": "retail store customer and organization"
}

# ========= SESSION STATE =========
if "step" not in st.session_state: st.session_state.step = 0
if "role" not in st.session_state: st.session_state.role = None
if "candidate_name" not in st.session_state: st.session_state.candidate_name = "Candidate"
if "history" not in st.session_state: st.session_state.history = []
if "current_answer" not in st.session_state: st.session_state.current_answer = ""

st.title("ğŸ¤ AI Interview Practice Partner")

# ========= ROLE + NAME SELECTION =========
if st.session_state.step == 0:
    st.session_state.role = st.selectbox("Select Interview Role", list(roles.keys()))
    st.session_state.candidate_name = st.text_input("Enter Candidate Name:", value="Candidate")
    if st.button("Start Interview"):
        st.session_state.step = 1
        st.session_state.history = []
        st.session_state.current_answer = ""
        st.rerun()

# ========= INTERVIEW QUESTIONS =========
elif st.session_state.step == 1:

    # Build the prompt for question generation
    if len(st.session_state.history) == 0:
        prompt = f"""
        You are an interviewer for the role of {st.session_state.role}.
        Candidate name: {st.session_state.candidate_name}
        RULES:
        - Ask ONLY the first interview question.
        - Do NOT add explanations, comments, or examples.
        - Output one line, concise, professional.
        """
    else:
        last_answer = st.session_state.history[-1]["answer"]
        prompt = f"""
        You are interviewing {st.session_state.candidate_name} for the role of {st.session_state.role}.
        Candidate answered: "{last_answer}"
        RULES:
        - Ask ONLY ONE follow-up question based on the answer.
        - Do NOT explain, comment, or give examples.
        - Output one line, concise, professional.
        """

    # Generate the question
    response = llm(prompt, max_tokens=150, temperature=0.7)
    question = response["choices"][0]["text"].strip()

    st.subheader(f"Question {len(st.session_state.history)+1} of 5")
    st.write(question)

    # Speak question
    if st.button("ğŸ”Š Hear Question"):
        engine.say(question)
        engine.runAndWait()

    # Text input
    user_input = st.text_input("Your Answer:", value=st.session_state.current_answer)

    # Voice input
    if st.button("ğŸ¤ Speak Answer"):
        recognizer = sr.Recognizer()
        with sr.Microphone() as source:
            st.write("Listeningâ€¦")
            audio = recognizer.listen(source)
            try:
                spoken = recognizer.recognize_google(audio)
                st.success(f"Transcript captured: {spoken}")
                st.session_state.current_answer = spoken
            except:
                st.error("Could not recognize voice")

    # Next question
    if st.button("Next âœ"):
        final_answer = user_input if user_input.strip() != "" else st.session_state.current_answer
        if final_answer.strip() == "":
            st.warning("Please provide an answer before continuing.")
        else:
            st.session_state.history.append({"question": question, "answer": final_answer})
            st.session_state.current_answer = ""
            # Limit to 5 questions
            if len(st.session_state.history) >= 5:
                st.session_state.step = 2
            st.rerun()

# ========= FINAL FEEDBACK =========
elif st.session_state.step == 2:
    st.header("ğŸ“ Interview Completed")
    st.write("Generating AI feedback...")

    transcript = "\n".join(
        [f"Q{i+1}: {h['question']}\nA{i+1}: {h['answer']}" for i, h in enumerate(st.session_state.history)]
    )

    feedback_prompt = f"""
    You are an HR interviewer analyzing a candidate interview for {st.session_state.role}.
    Candidate name: {st.session_state.candidate_name}
    Provide:
    - Strengths
    - Weaknesses
    - Score out of 100
    - Improvement tips
    Be concise and professional.
    Transcript:
    {transcript}
    """

    feedback = llm(feedback_prompt, max_tokens=350, temperature=0.4)
    result = feedback["choices"][0]["text"].strip()

    st.success("âœ” Feedback Generated")
    st.write(result)

    if st.button("ğŸ” Start Again"):
        st.session_state.step = 0
        st.session_state.history = []
        st.session_state.current_answer = ""
        st.session_state.candidate_name = "Candidate"
        st.rerun()
